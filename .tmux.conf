##### =========================================================
##### tmux.conf (hooks disabled, vim-hjkl navigation)
##### =========================================================

# -- general
setw -g xterm-keys on
set-window-option -g xterm-keys on
set -s escape-time 0
set -sg repeat-time 300
set -s focus-events on
set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'
set -g mouse on
set -sg exit-empty on
set -g detach-on-destroy off

# legacy UTF-8 options (harmless on modern 
bind 1 display-message "HIT prefix+1"tmux)
set -q -g status-utf8 on
setw -q -g utf8 on

set -g visual-activity off
setw -g monitor-activity off
setw -g monitor-bell off

set -g history-limit 10000

# reload configuration
bind r source-file ~/.tmux.conf \; display '~/.tmux.conf sourced'

# environment propagation
set -ga update-environment '\
DISPLAY DBUS_SESSION_BUS_ADDRESS \
QT_IM_MODULE QT_QPA_PLATFORMTHEME \
SESSION_MANAGER \
XDG_CONFIG_HOME XDG_CACHE_HOME XDG_DATA_HOME\
XDG_MENU_PREFIX XDG_RUNTIME_DIR XDG_SESSION_CLASS \
XDG_SESSION_DESKTOP XDG_SESSION_TYPE XDG_CURRENT_DESKTOP \
XMODIFIERS \
FZF_DEFAULT_OPTS \
TMUX_THEME_COLOR \
'

##### =========================================================
##### HOOKS / EVENT AUTOMATION  (DISABLED)
##### =========================================================
# The original config had extensive set-hook automation:
# - fzf panes MRU updates
# - agent-tracker integration
# - project window activate scripts
# - session lifecycle scripts
#
# All of those are intentionally disabled per request.

 set-hook -g pane-focus-in "run -b 'bash ~/.config/tmux/fzf_panes.tmux update_mru_pane_ids'"
# set-hook -ag client-attached 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command acknowledge --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
# set-hook -ag client-attached 'run -b "tmux refresh-client -S"'
# set-hook -ag pane-focus-in 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command acknowledge --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
# set-hook -ag pane-focus-in 'run -b "tmux refresh-client -S"'
# set-hook -ag pane-died 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command delete_task --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
# set-hook -ag pane-died 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command note_archive_pane --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
# set-hook -ag after-select-window 'run-shell "~/.config/tmux/scripts/check_and_run_on_activate.sh \"#{pane_current_path}\""'
set-hook -gu session-created
set-hook -ag session-created 'run -b "~/.config/tmux/scripts/session_created.sh"'
set-hook -ag session-created 'run -b "tmux refresh-client -S"'
set-hook -gu session-renamed
set-hook -g session-renamed 'run -b "tmux refresh-client -S"'
set-hook -gu session-closed
set-hook -g session-closed 'run -b "tmux refresh-client -S"'
run-shell "~/.config/tmux/scripts/session_created.sh"


##### =========================================================
##### prefix
##### =========================================================
unbind C-b
set -g prefix 'C-s'

##### =========================================================
##### display / indexing
##### =========================================================
set -g base-index 1
setw -g pane-base-index 1

setw -g automatic-rename on
set -g renumber-windows on

set -g set-titles on

set -g display-panes-time 2000
set -g display-time 2000


##### =========================================================
##### navigation / session / window / pane
##### =========================================================

# create session
bind C-c new-session
bind -n M-S run-shell "~/.config/tmux/scripts/new_session.sh"
bind -n M-b break-pane
bind -n M-s run-shell "~/.config/tmux/scripts/toggle_scratchpad.sh"

# window management
bind -n M-W new-window -c "#{pane_current_path}"
bind -n M-Q kill-pane
bind -n M-t run-shell "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command toggle --client '#{client_tty}' || true"

bind . command-prompt -p "Rename session to:" "run-shell \"~/.config/tmux/scripts/rename_session_prompt.sh '%%'\""
unbind ,
bind , command-prompt -p "Rename window:" "rename-window '%%'"

# window navigation (replace defaults)
unbind n
unbind p
bind -n M-u previous-window
bind -n M-o next-window

bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# join-pane shortcuts (unchanged)
bind -n M-! join-pane -t :1
bind -n M-@ join-pane -t :2
bind -n 'M-#' join-pane -t :3
bind -n 'M-$' join-pane -t :4
bind -n M-% join-pane -t :5
bind -n M-^ join-pane -t :6
bind -n M-& join-pane -t :7
bind -n M-* join-pane -t :8
bind -n M-( join-pane -t :9

# split windows (changed to vim-like hjkl under prefix)
# original used u/e/n/i (Colemak-oriented); now use h/j/k/l
unbind u
unbind e
unbind n
unbind i
bind k split-window -vb -c "#{pane_current_path}"   # split above (new pane on top)
bind j split-window -v  -c "#{pane_current_path}"   # split below
bind h split-window -hb -c "#{pane_current_path}"   # split left (new pane on left)
bind l split-window -h  -c "#{pane_current_path}"   # split right

# zoom pane
bind -n M-f resize-pane -Z

# paste from system clipboard
bind -n C-S-v run -b "~/.config/tmux/scripts/paste_from_clipboard.sh"
bind -T copy-mode-vi C-S-v send-keys -X cancel \; run -b "~/.config/tmux/scripts/paste_from_clipboard.sh"
bind -T copy-mode C-S-v send-keys -X cancel \; run -b "~/.config/tmux/scripts/paste_from_clipboard.sh"

# Alt+Shift+V paste
bind -n M-V run -b "~/.config/tmux/scripts/paste_from_clipboard.sh"
bind -T copy-mode-vi M-V send-keys -X cancel \; run -b "~/.config/tmux/scripts/paste_from_clipboard.sh"
bind -T copy-mode M-V send-keys -X cancel \; run -b "~/.config/tmux/scripts/paste_from_clipboard.sh"

# move current window to session index (script-based)
#bind 1 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 1"
#bind 2 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 2"
#bind 3 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 3"
#bind 4 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 4"
#bind 5 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 5"
#bind 6 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 6"
#bind 7 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 7"
#bind 8 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 8"
#bind 9 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 9"
#bind 0 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 10"

# pane navigation (vim hjkl) - no prefix
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# swap pane
bind > swap-pane -D
bind < swap-pane -U
bind | swap-pane

# agent-tracker quick focus scripts (kept; safe if missing due to test)
bind -n M-m run-shell "test -f ~/.config/agent-tracker/scripts/focus_latest_notified.sh && bash ~/.config/agent-tracker/scripts/focus_latest_notified.sh || true"
bind -n M-M run-shell "test -f ~/.config/agent-tracker/scripts/focus_last_origin.sh && bash ~/.config/agent-tracker/scripts/focus_last_origin.sh || true"

# toggle split orientation
bind Space run-shell "~/.config/tmux/scripts/toggle_orientation.sh"

# choose-tree
bind W choose-tree -Z
bind S choose-tree 'move-pane -v -s "%%"'
bind V choose-tree 'move-pane -h -s "%%"'

# pane resizing (vim HJKL) - no prefix
unbind -n M-N
unbind -n M-E
unbind -n M-U
unbind -n M-I
bind -n M-H resize-pane -L 3
bind -n M-J resize-pane -D 3
bind -n M-K resize-pane -U 3
bind -n M-L resize-pane -R 3


##### =========================================================
##### copy mode / buffers
##### =========================================================
set -g status-keys emacs
set -g mode-keys vi

bind -n M-v copy-mode

# selection
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle

# vim hjkl movement in copy-mode-vi (replaces Colemak n/e/u/i)
bind -T copy-mode-vi h send-keys -X cursor-left
bind -T copy-mode-vi l send-keys -X cursor-right
bind -T copy-mode-vi k send-keys -X cursor-up
bind -T copy-mode-vi j send-keys -X cursor-down
bind -T copy-mode-vi K send-keys -N 5 -X cursor-up
bind -T copy-mode-vi J send-keys -N 5 -X cursor-down

# start/end of line (more vim-like)
bind -T copy-mode-vi 0 send-keys -X start-of-line
bind -T copy-mode-vi $ send-keys -X end-of-line

# copy to clipboard
bind -T copy-mode-vi Y send-keys -X copy-end-of-line
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "~/.config/tmux/scripts/copy_to_clipboard.sh"

# search keys (left as original)
bind -T copy-mode-vi = send-keys -X search-again
bind -T copy-mode-vi = send-keys -X search-reverse

# list/paste buffers
bind b list-buffers
bind p paste-buffer


##### =========================================================
##### session/window ordering shortcuts (Colemak l/y replaced)
##### =========================================================

# session ordering: prefix + H/L (vim semantics)
unbind U
unbind O
bind \{ run-shell "~/.config/tmux/scripts/move_session.sh left"
bind \} run-shell "~/.config/tmux/scripts/move_session.sh right"

# swap window: avoid conflict with Alt+l used for pane-right
# replace M-l/M-y with M-</M->
unbind -n M-y
bind [ swap-window -d -t :-1
bind ] swap-window -d -t :+1

# layout builder (kept; still uses original script calls)
bind L run-shell "~/.config/tmux/scripts/layout_builder.sh right"
bind H run-shell "~/.config/tmux/scripts/layout_builder.sh left"
bind K run-shell "~/.config/tmux/scripts/layout_builder.sh up"
bind J run-shell "~/.config/tmux/scripts/layout_builder.sh down"


##### =========================================================
##### toggle synchronized input
##### =========================================================
bind C-g if-shell '[[ $(tmux showw synchronize-panes | cut -d\  -f2) == "on" ]]' \
'setw synchronize-panes off; set -g pane-border-style fg=#{?#{!=:#{environ:TMUX_THEME_COLOR},},#{environ:TMUX_THEME_COLOR},#b294bb}' \
'setw synchronize-panes on; set -g pane-border-style fg=red'


##### =========================================================
##### theme / status line
##### =========================================================

# panes
run-shell "~/.config/tmux/scripts/update_theme_color.sh"
setw -g pane-border-status top
set -g pane-active-border-style fg=#b294bb
set -g pane-border-style fg=colour244

setw -g pane-border-format '#{?pane_active, #[fg=#{@theme_color}]#[bg=#{@theme_color}]#[fg=#1d1f21]#[bold] #{?window_zoomed_flag,⛶ ,} #(~/.config/tmux/scripts/pane_starship_title.sh #{pane_pid} #{pane_width} "#{pane_current_path}" "#{pane_current_command}") #[bg=default]#[fg=#{@theme_color}]#[default], #[fg=colour244]#[bg=colour244]#[fg=#1d1f21] #{?window_zoomed_flag,⛶ ,} #(~/.config/tmux/scripts/pane_starship_title.sh #{pane_pid} #{pane_width} "#{pane_current_path}" "#{pane_current_command}") #[bg=default]#[fg=colour244]#[default] }'

# windows
set -g status-justify 'left'
set -g status-left-length 90
set -g status-right-length 140
setw -g window-status-separator ''

set -g status-bg black
setw -g window-status-format '#[fg=#c5c8c6] #W '
setw -g window-status-current-format '#[fg=#{@theme_color},bold] #W '
setw -g window-status-activity-style bg=black
setw -g window-status-bell-style bg=black

set-option -g status-left "#(~/.config/tmux/tmux-status/left.sh \"#{session_id}\" \"#{session_name}\")   "
set-option -g status-right "#(~/.config/tmux/tmux-status/right.sh)"


##### =========================================================
##### session index switching (kept)
##### =========================================================
unbind 1
unbind 2
unbind 3
unbind 4
unbind 5
unbind 6
unbind 7
unbind 8
unbind 9

#bind -n C-1 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 1"
#bind -n C-2 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 2"
#bind -n C-3 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 3"
#bind -n C-4 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 4"
#bind -n C-5 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 5"
#bind -n C-6 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 6"
#bind -n C-7 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 7"
#bind -n C-8 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 8"
#bind -n C-9 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 9"

bind -n F1 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 1"
bind -n F2 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 2"
bind -n F3 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 3"
bind -n F4 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 4"
bind -n F5 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 5"

bind 1 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 1"
bind 2 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 2"
bind 3 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 3"
bind 4 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 4"
bind 5 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 5"
bind 6 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 6"
bind 7 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 7"
bind 8 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 8"
bind 9 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 9"

##### =========================================================
##### true color support
##### =========================================================
set -g default-terminal "tmux-256color"
set -as terminal-features ",*256col*:RGB"
set -as terminal-overrides ",*256col*:Tc"

# copy-mode scroll keys (kept)
unbind -T copy-mode-vi C-k
unbind -T copy-mode-vi C-j
bind -T copy-mode-vi C-k send-keys -N 5 -X scroll-up
bind -T copy-mode-vi C-j send-keys -N 5 -X scroll-down

